<link rel="stylesheet" type="text/css" href="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/css/styles.css">

<script type="text/javascript" src="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/libs/jquery-2.2.4.min.js"></script>

<script type="text/javascript" src="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/libs/bootstrap.min.js"></script>

<script type="text/javascript" src="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/js/snbApp_NamespaceObj.js"></script>

<script type="text/javascript" src="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/js/sp.listarray.js"></script>

<script type="text/javascript" src="https://staging-team.usace.army.mil/sites/ACEIT/PMO/O/O/I/E/Web%20Apps%20Custom%20Code/SNLookupUtility/js/data.retriever.new.js"></script>


<div id="appHolder">
	<p>The lookup only works for COE- prefixed server names consisting of exactly 15 characters</p>
    <div class="row form-inline sectionHolder">
        <input class="form-control" id="user_input" type="text" style="Width:322px; display:inline-block" maxlength="15" title="15 characters starting with &quot;COE-&quot;" placeholder="Server Name" style="text-transform:uppercase;">
        <button id="goFind" type="submit" class="btn btn-default" style="display:inline-block">Lookup</button>
    </div>
    
    <div class="row sectionHolder hide" id="messages"></div>
    
    <div class="row form-inline sectionHolder" id="primary_activity_holder">
        <input class="form-control section" id="primary_activity_code" type="text">
        <input class="form-control sectionDescription" id="primary_activity_code_desc" type="text">
    </div>

    <div class="row form-inline sectionHolder" id="secondary_activity_holder">
        <input class="form-control section" id="secondary_activity_code" type="text">
        <input class="form-control sectionDescription" id="secondary_activity_code_desc" type="text">
    </div>

    <div class="row form-inline sectionHolder" id="primary_function_holder">
        <input class="form-control section" id="primary_function_code" type="text">
        <input class="form-control sectionDescription" id="primary_function_code_desc" type="text">
    </div>

    <div class="row form-inline sectionHolder" id="secondary_function_holder">
        <input class="form-control section" id="secondary_function_code" type="text">
        <input class="form-control sectionDescription" id="secondary_function_code_desc" type="text">
    </div>
    
    <div class="row form-inline sectionHolder" id="number_sequence_holder">
        <input class="form-control section" id="number_sequence" type="text">
        <input class="form-control sectionDescription" id="number_sequence_desc" type="text">
    </div>

    <div class="row form-inline sectionHolder" id="site_locations_holder">
        <input class="form-control section" id="site_locations" type="text">
        <input class="form-control sectionDescription" id="site_locations_desc" type="text">
    </div>
    
    <div class="row form-inline sectionHolder" id="site_code_holder">
        <input class="form-control section" id="site_code" type="text">
        <input class="form-control sectionDescription" id="site_code_desc" type="text">
    </div>
    
    <div class="row form-inline sectionHolder" id="lifecycle_holder">
        <input class="form-control section" id="lifecycle" type="text">
        <input class="form-control sectionDescription" id="lifecycle_desc" type="text">
    </div>

</div>

<script type="text/javascript">
    function _onQueryFailed(sender, args) {
        alert('Request failed.\nError: ' + args.get_message() + '\nStackTrace: ' + args.get_stackTrace());
    }
    
	//Tests the user's input and hides and shows message field as needed
    function checkInput(uInput){
        if(uInput.length === 15 && uInput.substring(0,4)=== "COE-"){
            if(document.getElementById("messages").classList.contains('show')){
                document.getElementById("messages").classList.remove('show');
                document.getElementById("messages").classList.add('hide');
            };
            return true;
        } else {
            document.getElementById("messages").classList.remove('hide');
            document.getElementById("messages").classList.add('show');
            document.getElementById("messages").innerHTML="Server names consist of exactly 15 characters and are prefixed with &quot;COE-&quot;. Please try again.";
            var allDesc = document.querySelectorAll("input.sectionDescription");
            var i = 0;
            var descLength = allDesc.length;
            for(i;i<descLength;i++){
                allDesc[i].value = "";
            }
            return false;
        } 
    }
    
    function ListDetails(listName){
        this.listName = listName;
    }
	
	function startTheLookup(){
		
	}
	
	$("#user_input").keypress(function(e){
		if(e.which === '13'){
			var u_input = document.getElementById('user_input').value;
			document.getElementById('site_locations_holder').classList.remove("hide");
			document.getElementById('site_code_holder').classList.remove("hide");
			document.getElementById('lifecycle_holder').classList.remove("hide");
			document.getElementById('site_locations_holder').classList.add("show");
			document.getElementById('site_code_holder').classList.add("show");
			document.getElementById('lifecycle_holder').classList.add("show");
			
			//If user input is valid, determines the OS type of server
			//and whether hosted at site or at data center or off-premise
			//creates an object to pass to data.retriever.new
			if(checkInput(u_input)){
				var serverType = "";
				var server_pattern = /u/i;
				
				//test for OS type
				if(server_pattern.test(u_input.substring(7,9))){
				  serverType = "unix";
				} else {
				  serverType = "windows";
				}
				
				var uInputSubStringArray = [
				  {primary_activity_code:u_input.substring(0,4).toUpperCase()},
				  {secondary_activity_code:u_input.substring(4,7).toUpperCase()},
				  {primary_function_code:u_input.substring(7,9).toUpperCase()},
				  {secondary_function_code:u_input.substring(9,10).toUpperCase()},
				  {number_sequence:u_input.substring(10,12).toUpperCase()},
				];
				
				var hostOption = "";
				var host_pattern = /^dc|^op/i;
				
				//test for host option
				if(host_pattern.test(u_input.substring(12))){
					hostOption = "dc_or_op";
					uInputSubStringArray.push({site_code:u_input.substring(12,14).toUpperCase()});
					uInputSubStringArray.push({lifecycle:u_input.substring(14).toUpperCase()});
					document.getElementById('site_locations_holder').classList.remove("show");
					document.getElementById('site_locations_holder').classList.add("hide");
				}else{
					hostOption = "site";
					uInputSubStringArray.push({site_locations:u_input.substring(12).toUpperCase()});
					document.getElementById('site_code_holder').classList.remove("show");
					document.getElementById('lifecycle_holder').classList.remove("show");
					document.getElementById('site_code_holder').classList.add("hide");
					document.getElementById('lifecycle_holder').classList.add("hide");
				}
				
				var serverTypeListArray = snbApp.getArrayOfListsForObjects(serverType);
				
				//object that is passed to getListDetails
				var myObj = {
				  hostOption:hostOption,
				  serverType:serverType,
				  listsArray:serverTypeListArray, //array of all lists needed
				  subStringsArray:uInputSubStringArray, //an array of objects consisting of list name and substrings
				};
				
				//starts the process of building the response using .ajax
				var clientContext = new SP.ClientContext.get_current();
				clientContext.executeQueryAsync(snbApp.sp_single_list.getListDetails(myObj,_onQueryFailed));
			};
			return false;
			event.preventDefault();
		}
	});
	
	//Event that starts the lookup process
    $("#goFind").on('click',function(){
		//startTheLookup();
        var u_input = document.getElementById('user_input').value;
        document.getElementById('site_locations_holder').classList.remove("hide");
        document.getElementById('site_code_holder').classList.remove("hide");
        document.getElementById('lifecycle_holder').classList.remove("hide");
        document.getElementById('site_locations_holder').classList.add("show");
        document.getElementById('site_code_holder').classList.add("show");
        document.getElementById('lifecycle_holder').classList.add("show");
        
		//If user input is valid, determines the OS type of server
		//and whether hosted at site or at data center or off-premise
		//creates an object to pass to data.retriever.new
        if(checkInput(u_input)){
            var serverType = "";
            var server_pattern = /u/i;
			
			//test for OS type
            if(server_pattern.test(u_input.substring(7,9))){
              serverType = "unix";
            } else {
              serverType = "windows";
            }
            
            var uInputSubStringArray = [
              {primary_activity_code:u_input.substring(0,4).toUpperCase()},
              {secondary_activity_code:u_input.substring(4,7).toUpperCase()},
              {primary_function_code:u_input.substring(7,9).toUpperCase()},
              {secondary_function_code:u_input.substring(9,10).toUpperCase()},
              {number_sequence:u_input.substring(10,12).toUpperCase()},
            ];
            
            var hostOption = "";
            var host_pattern = /^dc|^op/i;
			
			//test for host option
            if(host_pattern.test(u_input.substring(12))){
                hostOption = "dc_or_op";
                uInputSubStringArray.push({site_code:u_input.substring(12,14).toUpperCase()});
                uInputSubStringArray.push({lifecycle:u_input.substring(14).toUpperCase()});
                document.getElementById('site_locations_holder').classList.remove("show");
                document.getElementById('site_locations_holder').classList.add("hide");
            }else{
                hostOption = "site";
                uInputSubStringArray.push({site_locations:u_input.substring(12).toUpperCase()});
                document.getElementById('site_code_holder').classList.remove("show");
                document.getElementById('lifecycle_holder').classList.remove("show");
                document.getElementById('site_code_holder').classList.add("hide");
                document.getElementById('lifecycle_holder').classList.add("hide");
            }
            
            var serverTypeListArray = snbApp.getArrayOfListsForObjects(serverType);
            
			//object that is passed to getListDetails
            var myObj = {
              hostOption:hostOption,
              serverType:serverType,
              listsArray:serverTypeListArray, //array of all lists needed
              subStringsArray:uInputSubStringArray, //an array of objects consisting of list name and substrings
            };
            
            //starts the process of building the response using .ajax
            var clientContext = new SP.ClientContext.get_current();
            clientContext.executeQueryAsync(snbApp.sp_single_list.getListDetails(myObj,_onQueryFailed));
        }else{
            document.getElementById('primary_activity_code').value = "";
            document.getElementById('secondary_activity_code').value = "";
            document.getElementById('primary_function_code').value = "";
            document.getElementById('secondary_function_code').value = "";
            document.getElementById('number_sequence').value = "";
            document.getElementById('site_locations').value = "";
            document.getElementById('site_code').value = "";
            document.getElementById('lifecycle').value = "";
        };
         
        
        return false;
        event.preventDefault();
    });
    
    
    document.getElementById("user_input").addEventListener("keypress",function(event){
        var myString = document.getElementById("user_input").value;
        if(myString.length === 4){
        //console.log("Hi " + event.eventPhase + ", " + event.keyCode + ", " + event.charCode + ", " + myString);
        }   
    });
</script>